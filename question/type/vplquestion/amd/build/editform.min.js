define(["jquery","jqueryui","core/log","qtype_vplquestion/vplservice","qtype_vplquestion/codeeditors","qtype_vplquestion/scriptsloader"],function(a,b,c,d,e,f){function g(a,b){a.getSession().setValue(b),a.getSession().setUndoManager(new ace.UndoManager)}function h(){var b=a("#id_templatevpl").val()>"",c="diff"==a("#id_precheckpreference").val();a(".novplmessage").toggle(!b),a("#execfileslist, #fitem_id_execfile").toggle(b),a("#fitem_id_precheckexecfileslist").toggle(c),a("#precheckexecfileslist, #fitem_id_precheckexecfile").toggle(b&&c),a("#ace_placeholder_precheckexecfile").length&&ace.edit("ace_placeholder_precheckexecfile").resize()}function i(b){var e=a("#id_templatevpl").val();a("#fitem_id_templatecontext").toggle(e>""),h(),e&&(d.call("info","reqfile",e).then(function(c){var e=d.langOfFile(c.name);a(".code-editor:not(.manylangs) .ace-placeholder").each(function(){ace.edit(this).getSession().setMode("ace/mode/"+e)}),a("[name=templatelang]").val(e),b||g(ace.edit("ace_placeholder_templatecontext"),c.contents)}).fail(c.error),d.call("info","execfiles",e).then(function(c){j(c=c.filter(function(a){return!["vpl_run.sh","vpl_debug.sh","vpl_evaluate.sh","pre_vpl_run.sh"].includes(a.name)}),b,"#execfileslist","ace_placeholder_execfile",a("[name=execfiles]")),j(c,b,"#precheckexecfileslist","ace_placeholder_precheckexecfile",a("[name=precheckexecfiles]"))}).fail(c.error))}function j(b,c,d,e,f){var g=ace.edit(e),h=a(d).html(""),i={},j=f.val().length>0?JSON.parse(f.val()):{};b.forEach(function(a){var b=c&&j[a.name]||a.contents;i[a.name]=b,h.append('<li class="execfilename float-left"><span class="clickable rounded-top'+(b.startsWith("UNUSED")?" unused":"")+'">'+a.name+"</span></li>")}),f.val(JSON.stringify(i)),a(d+" .execfilename span").click(function(b){a(this).is(".currentfile")||l(a(d+" .currentfile"),a(this),g,f),b.preventDefault()}),a("input[type=submit]").click(function(){k(a(d+" .currentfile").text(),g.getValue(),f)}),l(null,a(d+" .execfilename span").first(),g,f)}function k(a,b,c){var d=JSON.parse(c.val());d[a]=b,c.val(JSON.stringify(d))}function l(a,b,c,e){var f=c.getValue();null!==a&&(a.removeClass("currentfile"),a.toggleClass("unused",f.startsWith("UNUSED")),k(a.text(),f,e)),b.addClass("currentfile");var h=b.text();c.getSession().setMode("ace/mode/"+d.langOfFile(h)),g(c,JSON.parse(e.val())[h])}return{setup:function(b,c,d){e.setupFormEditors(b,function(){f.loadVPLUtil(d,function(){var b,d,e,f;i(!0),b=c,d=a("#id_templatevpl"),e=M.util.get_string("templatevplchangeprompt","qtype_vplquestion")+b,f=a('<div class="py-3">'+e+"</div>").dialog({autoOpen:!1,dialogClass:"vplchangedialog p-3 bg-white",title:M.util.get_string("templatevplchange","qtype_vplquestion"),closeOnEscape:!1,modal:!0,buttons:[{text:M.util.get_string("overwrite","qtype_vplquestion"),class:"btn btn-primary mx-1",click:function(){d.data("current",d.val()),a(this).dialog("close"),i(!1)}},{text:M.util.get_string("merge","qtype_vplquestion"),class:"btn btn-primary mx-1",click:function(){d.data("current",d.val()),a(this).dialog("close"),i(!0)}},{text:M.util.get_string("cancel","moodle"),class:"btn btn-secondary mx-1",click:function(){d.val(d.data("current")),a(this).dialog("close")}}],open:function(){a(".vplchangedialog").focus()}}),d.focus(function(){a(this).data("current",a(this).val())}).change(function(){d.val()&&""!=a("[name=execfiles]").val()?f.dialog("open"):(d.data("current",d.val()),i(!1))}),a("#id_precheckpreference").change(h)})})}}});