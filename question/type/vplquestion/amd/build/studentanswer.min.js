define(["jquery","qtype_vplquestion/codeeditors","qtype_vplquestion/vplservice","qtype_vplquestion/scriptsloader"],function(a,b,c,d){function e(a){switch(a){case"console":return"[Process";case"connected":case"connecting":case"running":return"running]";case"connection_closed":return"exited]";default:return a}}function f(a,b,c){if(a[b]){var d="";return(e=a[b],f={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"},e.replace(/[&<>"']/g,function(a){return f[a]})).split("\n").forEach(function(a){"-"==a.charAt(0)&&(a='<span class="vpl-test-title font-italic rounded px-1">'+a+"</span>"),d+=a+"\n"}),'<span class="vpl-result-title vpl-title-'+c+' d-block font-weight-bold border border-dark pl-1 mb-1">'+M.util.get_string(b,"qtype_vplquestion")+"</span>"+d.trim()}var e,f;return""}function g(b,c){var d=a("#"+b);null===c&&(c=d.data("result"));var e=f(c,"compilation","error")+f(c,"evaluation","info")+f(c,"execerror","error")+f(c,"evaluationerror","error");e||(e=f(c,"execution","error")),d[e?"show":"hide"](),d.html(e)}return{setup:function(f,h,i,j,k,l){var m=a('textarea[name="'+k+'"]'),n=a("#qvpl_reset_q"+f+", #qvpl_correction_q"+f);b.setupQuestionEditor(j,m,n,m.data("lineoffset"),function(){"readonly"!=m.attr("readonly")&&d.loadVPLTerminal(l,function(){var b=Terminal.prototype;Terminal=function(a){return a.rows=10,new b.constructor(a)},Terminal.prototype=b;var d="terminal_wrapper_q"+f,j=new VPLTerminal(d,d,e);j.setMessage=function(){};var k="#qvpl_buttons_q"+f,l=a("#"+d).parent();l.insertAfter(k);var n=j.connect;j.connect=function(){n.apply(j,arguments),l.css("top",0).css("left",0),a("body > .ui-widget-overlay.ui-front").first().remove()},l.find(".ui-dialog-titlebar-close").html('<i class="fa fa-close"></i>').addClass("btn btn-secondary close-terminal");var o=function(b,d,e){var l=a(k+' button[data-action="'+b+'"]'),n=a('<i class="fa fa-'+d+' ml-2"></i>').appendTo(l),o=function(){n.attr("class","fa fa-"+d+" ml-2"),a(".qvpl-buttons *").removeAttr("disabled")};l.click(function(){a(".qvpl-buttons *").attr("disabled","disabled"),a(".close-terminal").trigger("click"),n.attr("class","fa fa-refresh fa-spin ml-2"),c.call("save",h,f,m.val(),e).then(function(){return c.call("exec",b,h,i,j,function(a){g("vpl_result_q"+f,a),o()})}).fail(function(a){g("vpl_result_q"+f,{execerror:a}),o()})})};o("run","rocket","run"),o("debug","check-square-o","precheck"),o("evaluate","check-square-o","precheck")})})},displayResult:g}});